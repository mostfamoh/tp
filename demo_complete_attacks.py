"""
Script de d√©monstration compl√®te - Partie 3
Cr√©ation de 3 utilisateurs avec diff√©rents niveaux de complexit√© et test des attaques

Utilisateurs cr√©√©s:
1. test_weak_012 - Mot de passe: "012" (charset: {0,1,2})
2. test_medium_123456 - Mot de passe: "123456" (charset: {0-9})
3. test_strong_aB3@x - Mot de passe: "aB3@x" (charset: a-z, A-Z, 0-9, sp√©ciaux)
"""

import sys
import os
import json
import django

# Configuration Django
project_root = os.path.abspath(os.path.dirname(__file__))
sys.path.insert(0, project_root)
os.environ.setdefault('DJANGO_SETTINGS_MODULE', 'core.settings')
django.setup()

from crypto_lab.models import CustomUser
from backend.cryptotoolbox import encrypt_with_algorithm
from backend.cryptotoolbox.attack.attack_runner import run_attack


def print_section(title):
    """Afficher une section format√©e"""
    print("\n" + "="*80)
    print(f"  {title}")
    print("="*80 + "\n")


def create_test_user(username, password, algorithm, key_data, description):
    """Cr√©er un utilisateur de test avec son mot de passe chiffr√©"""
    print(f"üìù Cr√©ation de l'utilisateur: {username}")
    print(f"   Mot de passe: {password}")
    print(f"   Description: {description}")
    
    # Supprimer l'utilisateur s'il existe d√©j√†
    CustomUser.objects.filter(username=username).delete()
    
    # Convertir les chiffres en lettres pour le chiffrement
    digit_to_letter = {str(i): chr(ord('A') + i) for i in range(10)}
    password_for_encryption = ''.join(digit_to_letter.get(c, c) for c in password)
    
    print(f"   Conversion pour chiffrement: {password} ‚Üí {password_for_encryption}")
    
    # Chiffrer le mot de passe
    encrypted = encrypt_with_algorithm(algorithm, password_for_encryption, key_data)
    print(f"   Algorithme: {algorithm}")
    print(f"   Cl√©: {key_data}")
    print(f"   Mot de passe chiffr√©: {encrypted}")
    
    # Cr√©er l'utilisateur
    user = CustomUser.objects.create(
        username=username,
        password_encypted=encrypted,
        algorithm=algorithm,
        key_data=json.dumps(key_data)
    )
    
    print(f"‚úÖ Utilisateur cr√©√© avec succ√®s!\n")
    return user


def run_brute_force_attack(username, description):
    """Ex√©cuter une attaque par force brute"""
    print(f"\n‚öîÔ∏è  ATTAQUE PAR FORCE BRUTE sur {username}")
    print(f"   {description}\n")
    
    instruction = {
        "target_username": username,
        "mode": "bruteforce",
        "limit": 0,  # Pas de limite
        "max_seconds": 60  # Maximum 60 secondes
    }
    
    result = run_attack(instruction)
    
    if result.get('error'):
        print(f"‚ùå ERREUR: {result['error']}")
        return result
    
    print(f"üìä R√âSULTATS:")
    print(f"   Algorithme: {result['algorithm']}")
    print(f"   Tentatives: {result['attempts']:,}")
    print(f"   Temps √©coul√©: {result['time_sec']:.6f} secondes")
    print(f"   Vitesse: {result['attempts']/result['time_sec']:,.0f} tentatives/seconde")
    print(f"   Correspondances trouv√©es: {result['matches_count']}")
    
    if result['matches_count'] > 0:
        print(f"\n   ‚úÖ MOT DE PASSE TROUV√â!")
        top_match = result['matches'][0]
        print(f"   Candidat: {top_match['candidate_plaintext']}")
        print(f"   Cl√©: {top_match['candidate_key']}")
        print(f"   Confiance: {top_match['confidence']}")
        print(f"   Note: {top_match['notes']}")
    else:
        print(f"\n   ‚ùå Aucun mot de passe trouv√©")
    
    if result.get('timeout_reached'):
        print(f"   ‚è±Ô∏è  TIMEOUT: Limite de temps atteinte")
    
    if result.get('limit_reached'):
        print(f"   üõë LIMITE: Nombre maximum de tentatives atteint")
    
    return result


def run_dictionary_attack(username, dictionary, description):
    """Ex√©cuter une attaque par dictionnaire"""
    print(f"\nüìñ ATTAQUE PAR DICTIONNAIRE sur {username}")
    print(f"   {description}")
    print(f"   Taille du dictionnaire: {len(dictionary)} mots\n")
    
    instruction = {
        "target_username": username,
        "mode": "dictionary",
        "dictionary": dictionary
    }
    
    result = run_attack(instruction)
    
    if result.get('error'):
        print(f"‚ùå ERREUR: {result['error']}")
        return result
    
    print(f"üìä R√âSULTATS:")
    print(f"   Algorithme: {result['algorithm']}")
    print(f"   Tentatives: {result['attempts']:,}")
    print(f"   Temps √©coul√©: {result['time_sec']:.6f} secondes")
    print(f"   Vitesse: {result['attempts']/result['time_sec']:,.0f} tentatives/seconde")
    print(f"   Correspondances trouv√©es: {result['matches_count']}")
    
    if result['matches_count'] > 0:
        print(f"\n   ‚úÖ MOT DE PASSE TROUV√â!")
        top_match = result['matches'][0]
        print(f"   Candidat: {top_match['candidate_plaintext']}")
        print(f"   Cl√©: {top_match['candidate_key']}")
        print(f"   Confiance: {top_match['confidence']}")
    else:
        print(f"\n   ‚ùå Aucun mot de passe trouv√©")
    
    return result


def generate_dictionary_for_case(case_type):
    """G√©n√©rer un dictionnaire adapt√© au type de cas"""
    import itertools
    
    if case_type == 1:
        # Cas 1: 3 caract√®res {0,1,2}
        charset = "012"
        length = 3
        # G√©n√©rer toutes les combinaisons possibles
        return [''.join(p) for p in itertools.product(charset, repeat=length)]
    
    elif case_type == 2:
        # Cas 2: 6 chiffres {0-9}
        # G√©n√©rer un √©chantillon de mots de passe communs
        common = ["123456", "000000", "111111", "123123", "654321", "012345"]
        # Ajouter quelques combinaisons al√©atoires
        import random
        for _ in range(1000):
            pwd = ''.join(random.choice("0123456789") for _ in range(6))
            if pwd not in common:
                common.append(pwd)
        return common
    
    elif case_type == 3:
        # Cas 3: Alphanum√©rique + sp√©ciaux
        common = ["aB3@x", "Pass123!", "Qwerty1@", "Test@123", "Admin@1"]
        # Ajouter quelques variations
        import random
        import string
        charset = string.ascii_letters + string.digits + "@#$%"
        for _ in range(1000):
            pwd = ''.join(random.choice(charset) for _ in range(5))
            common.append(pwd)
        return common


def main():
    """Fonction principale"""
    print_section("D√âMONSTRATION COMPL√àTE - PARTIE 3")
    print("Ce script cr√©e 3 utilisateurs avec diff√©rents niveaux de s√©curit√©")
    print("et teste les attaques par force brute et dictionnaire sur chacun.\n")
    
    # Ajouter les utilisateurs au fichier test_users.txt
    test_users_file = os.path.join(project_root, 'test_users.txt')
    with open(test_users_file, 'r', encoding='utf-8') as f:
        existing_users = {line.strip() for line in f if line.strip()}
    
    new_users = {'test_weak_012', 'test_medium_123456', 'test_strong_aB3@x'}
    
    if not new_users.issubset(existing_users):
        with open(test_users_file, 'a', encoding='utf-8') as f:
            for user in new_users:
                if user not in existing_users:
                    f.write(f"\n{user}")
        print("‚úÖ Utilisateurs ajout√©s au fichier test_users.txt\n")
    
    # Stockage des r√©sultats
    all_results = {}
    
    # ==========================================================================
    # CAS 1 : MOT DE PASSE TR√àS FAIBLE
    # ==========================================================================
    print_section("CAS 1 : MOT DE PASSE TR√àS FAIBLE - {0,1,2}")
    
    user1 = create_test_user(
        username="test_weak_012",
        password="012",
        algorithm="caesar",
        key_data={"shift": 3},
        description="3 caract√®res parmi {0,1,2} - TR√àS FAIBLE"
    )
    
    # Attaque par force brute
    bf_result_1 = run_brute_force_attack(
        "test_weak_012",
        "Force brute sur espace de 27 combinaisons (3^3)"
    )
    
    # Attaque par dictionnaire
    dict_1 = generate_dictionary_for_case(1)
    dict_result_1 = run_dictionary_attack(
        "test_weak_012",
        dict_1,
        "Dictionnaire contenant toutes les combinaisons possibles"
    )
    
    all_results['case1'] = {
        'user': user1.username,
        'password': '012',
        'brute_force': bf_result_1,
        'dictionary': dict_result_1
    }
    
    # ==========================================================================
    # CAS 2 : MOT DE PASSE FAIBLE
    # ==========================================================================
    print_section("CAS 2 : MOT DE PASSE FAIBLE - {0-9}")
    
    user2 = create_test_user(
        username="test_medium_123456",
        password="123456",
        algorithm="caesar",
        key_data={"shift": 5},
        description="6 chiffres (0-9) - FAIBLE"
    )
    
    # Attaque par force brute (limit√©e)
    bf_result_2 = run_brute_force_attack(
        "test_medium_123456",
        "Force brute sur espace de 1,000,000 combinaisons (10^6)"
    )
    
    # Attaque par dictionnaire
    dict_2 = generate_dictionary_for_case(2)
    dict_result_2 = run_dictionary_attack(
        "test_medium_123456",
        dict_2,
        "Dictionnaire avec mots de passe communs"
    )
    
    all_results['case2'] = {
        'user': user2.username,
        'password': '123456',
        'brute_force': bf_result_2,
        'dictionary': dict_result_2
    }
    
    # ==========================================================================
    # CAS 3 : MOT DE PASSE MOYEN
    # ==========================================================================
    print_section("CAS 3 : MOT DE PASSE MOYEN - Alphanum√©rique + Sp√©ciaux")
    
    user3 = create_test_user(
        username="test_strong_aB3@x",
        password="aB3@x",
        algorithm="caesar",
        key_data={"shift": 7},
        description="5 caract√®res avec majuscules, minuscules, chiffres et sp√©ciaux - MOYEN"
    )
    
    # Attaque par force brute (tr√®s limit√©e, espace trop grand)
    bf_result_3 = run_brute_force_attack(
        "test_strong_aB3@x",
        "Force brute limit√©e (espace > 7 milliards de combinaisons)"
    )
    
    # Attaque par dictionnaire
    dict_3 = generate_dictionary_for_case(3)
    dict_result_3 = run_dictionary_attack(
        "test_strong_aB3@x",
        dict_3,
        "Dictionnaire avec variations de mots de passe"
    )
    
    all_results['case3'] = {
        'user': user3.username,
        'password': 'aB3@x',
        'brute_force': bf_result_3,
        'dictionary': dict_result_3
    }
    
    # ==========================================================================
    # R√âSUM√â FINAL
    # ==========================================================================
    print_section("R√âSUM√â COMPARATIF DES ATTAQUES")
    
    print("‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê")
    print("‚îÇ Utilisateur        ‚îÇ Mot de passe ‚îÇ Force Brute  ‚îÇ Dictionnaire     ‚îÇ")
    print("‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§")
    
    for case_id, data in all_results.items():
        bf = data['brute_force']
        di = data['dictionary']
        bf_status = "‚úÖ TROUV√â" if bf.get('matches_count', 0) > 0 else "‚ùå √âCHEC"
        di_status = "‚úÖ TROUV√â" if di.get('matches_count', 0) > 0 else "‚ùå √âCHEC"
        
        print(f"‚îÇ {data['user']:<18} ‚îÇ {data['password']:<12} ‚îÇ {bf_status:<12} ‚îÇ {di_status:<16} ‚îÇ")
    
    print("‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò")
    
    print("\nüìä STATISTIQUES D√âTAILL√âES:\n")
    
    for case_id, data in all_results.items():
        case_num = case_id[-1]
        print(f"CAS {case_num} - {data['user']}:")
        print(f"  Mot de passe: {data['password']}")
        
        bf = data['brute_force']
        if not bf.get('error'):
            print(f"  Force Brute:")
            print(f"    - Tentatives: {bf['attempts']:,}")
            print(f"    - Temps: {bf['time_sec']:.6f} secondes")
            print(f"    - R√©sultat: {'‚úÖ TROUV√â' if bf.get('matches_count', 0) > 0 else '‚ùå √âCHEC'}")
        
        di = data['dictionary']
        if not di.get('error'):
            print(f"  Dictionnaire:")
            print(f"    - Tentatives: {di['attempts']:,}")
            print(f"    - Temps: {di['time_sec']:.6f} secondes")
            print(f"    - R√©sultat: {'‚úÖ TROUV√â' if di.get('matches_count', 0) > 0 else '‚ùå √âCHEC'}")
        print()
    
    # Sauvegarder les r√©sultats
    output_file = os.path.join(project_root, 'demo_attack_results.json')
    with open(output_file, 'w', encoding='utf-8') as f:
        json.dump(all_results, f, ensure_ascii=False, indent=4)
    
    print(f"‚úÖ R√©sultats complets sauvegard√©s dans: {output_file}")
    
    print_section("CONCLUSIONS")
    print("1. CAS 1 (012) : Espace de 27 combinaisons")
    print("   ‚Üí Craqu√© INSTANTAN√âMENT par force brute")
    print("   ‚Üí ‚ùå EXTR√äMEMENT DANGEREUX\n")
    
    print("2. CAS 2 (123456) : Espace de 1 million de combinaisons")
    print("   ‚Üí Craqu√© en quelques millisecondes par force brute")
    print("   ‚Üí ‚ùå TR√àS DANGEREUX\n")
    
    print("3. CAS 3 (aB3@x) : Espace > 7 milliards de combinaisons")
    print("   ‚Üí Force brute limit√©e par le temps")
    print("   ‚Üí Peut √™tre trouv√© par dictionnaire si le mot est commun")
    print("   ‚Üí ‚ö†Ô∏è  MOYEN (mais insuffisant pour donn√©es sensibles)\n")
    
    print("üí° RECOMMANDATION:")
    print("   Utilisez des mots de passe de 12+ caract√®res avec:")
    print("   - Majuscules + minuscules + chiffres + caract√®res sp√©ciaux")
    print("   - Hachage fort (Argon2id)")
    print("   - Rate limiting (5 tentatives / 15 minutes)")
    print("   - Authentification multi-facteurs (MFA)")
    
    print("\n" + "="*80)


if __name__ == '__main__':
    try:
        main()
    except Exception as e:
        print(f"\n‚ùå ERREUR CRITIQUE: {e}")
        import traceback
        traceback.print_exc()
        sys.exit(1)
